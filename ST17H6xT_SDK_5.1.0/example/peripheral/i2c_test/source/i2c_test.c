#include "rom_sym_def.h"
#include "OSAL.h"
#include "gpio.h"
#include "clock.h"
#include "log.h"
#include "lcd_allvision.h"


typedef struct
{
    int16_t x;
    int16_t y;
    int16_t w;
    int16_t h;
} disp_rect_t;

void lcd_update_rect(disp_rect_t rect, const uint8_t* data)
{
    uint16_t page_s = rect.y/8, page_e = (rect.y+rect.h-1)/8;
    lcd_draw(page_s, rect.x, page_e, rect.w, data);//para0(0) 1 2(128) 3
}

disp_rect_t rect;
#define SCN_WIDTH           128
#define SCN_HEIGHT          64
#define FRAME_BUF_SIZE      (SCN_WIDTH*SCN_HEIGHT/8)

#define DISP_RECT_FULL(rect)    {   rect.x = 0;\
        rect.y = 0;\
        rect.w = SCN_WIDTH;\
        rect.h = SCN_HEIGHT;}
uint8_t fb[FRAME_BUF_SIZE];


uint8_t PIC1[] =                  // Êý¾Ý±í
{
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0xF8,0xFC,0x1C,0x38,0x30,0x38,0x1C,
    0xFC,0xF8,0x00,0xF8,0xF8,0x00,0xF8,0xF8,
    0x00,0x00,0x00,0xF8,0xFC,0x8C,0x8C,0x8C,
    0x00,0x80,0xD0,0x50,0xF0,0xE0,0x00,0xF0,
    0xF0,0x20,0x30,0x00,0x00,0x80,0x80,0x00,
    0x80,0x80,0x00,0x80,0x80,0x00,0x00,0x0C,
    0x12,0x24,0x12,0x0C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x18,0x24,0x44,0x88,
    0x44,0x24,0x18,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x03,0x83,0x80,0x00,0x80,0x80,0x00,
    0x03,0x03,0x00,0x08,0x0B,0x0B,0x0F,0x07,
    0x80,0x40,0x80,0x40,0x83,0x03,0x03,0x03,
    0x00,0x00,0x03,0x03,0x03,0x03,0x00,0x03,
    0x83,0x80,0x80,0x80,0x80,0xC3,0xC3,0xC0,
    0xC3,0xC3,0xC0,0xC3,0xC3,0xC0,0xC0,0xC0,
    0xC0,0xC0,0x80,0x80,0x80,0xC0,0xC0,0x40,
    0x20,0x18,0x04,0x03,0x00,0x00,0x00,0x00,
    0x00,0x20,0x50,0xA0,0x50,0x20,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x03,0x04,0x08,0x11,0x08,0x04,0x03,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x01,0x02,0x84,0xC2,0xE1,0x60,0x30,0x10,
    0x78,0xEC,0xFC,0xF6,0x3A,0x1B,0x05,0x85,
    0x97,0x13,0x12,0x13,0x13,0x11,0x11,0x11,
    0x11,0x11,0x11,0x01,0x81,0xFF,0xF9,0xF9,
    0xF2,0xC2,0x82,0x22,0x25,0x05,0x8D,0x8B,
    0x93,0xB3,0xE6,0xC6,0x8C,0x1C,0x18,0x38,
    0x70,0x70,0xE0,0xC0,0x80,0x00,0x00,0x00,
    0x00,0x00,0x00,0x18,0x24,0x48,0x24,0x18,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x80,0xE0,0xE0,0x70,0x30,0x18,
    0x18,0x1C,0x1C,0x1C,0x0C,0x1C,0x16,0x16,
    0x16,0x06,0x27,0x63,0x6D,0xAE,0xCE,0x0E,
    0x0E,0x0F,0x0F,0x0F,0x0E,0x06,0x06,0x07,
    0x07,0x06,0x06,0x06,0x06,0x06,0x06,0x06,
    0x06,0x06,0x06,0x66,0x77,0x67,0x67,0xE7,
    0x07,0x07,0x07,0x06,0x06,0x06,0x07,0x07,
    0x87,0xC7,0x67,0x23,0x23,0x12,0x10,0x00,
    0x08,0x08,0x09,0x0B,0x0F,0x0E,0x0E,0x0C,
    0x3C,0x70,0xF0,0xC0,0x80,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0xF8,
    0xDE,0xFF,0xF6,0x36,0x11,0xE0,0xF0,0xF8,
    0xFC,0xFE,0xDE,0x1E,0x3F,0x3F,0x1E,0xFE,
    0xFE,0xFC,0xF8,0xF2,0xE4,0x08,0x01,0x07,
    0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,
    0x00,0x00,0x00,0x00,0x00,0x3C,0xFF,0xE7,
    0x31,0x1C,0xE6,0xFF,0xFF,0xFF,0xFE,0xFE,
    0x1F,0x3F,0x3F,0x1F,0xFF,0xFE,0xFE,0xFC,
    0xF8,0xF8,0xF0,0x31,0xFB,0xFF,0xFE,0xFC,
    0x38,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,
    0x07,0x4F,0x4C,0x60,0x60,0x7F,0x7F,0x7F,
    0x7F,0x7D,0x4D,0x44,0x72,0x72,0x40,0x79,
    0x7D,0x7F,0x7F,0x7F,0x7F,0x7C,0x70,0x70,
    0x73,0x73,0x70,0x70,0x74,0x74,0x74,0x74,
    0x74,0x74,0x74,0x74,0x74,0x74,0x74,0x74,
    0x76,0x76,0x76,0x76,0x76,0x76,0x76,0x73,
    0x70,0x70,0x72,0x72,0x72,0x73,0x70,0x70,
    0x70,0x7C,0x7F,0x7F,0x7F,0x7F,0x7D,0x7D,
    0x62,0x72,0x72,0x60,0x68,0x7D,0x7F,0x7F,
    0x7F,0x7F,0x77,0x74,0x67,0x67,0x63,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

void i2c_test_for_ssd1315(void)
{
    int i;
    uint8_t testcase = 0;
    LOG("testcase:%d\n",testcase);

    switch(testcase)
    {
    case 0:
        lcd_init_x();
        lcd_on();
        DISP_RECT_FULL(rect);
        lcd_update_rect(rect, PIC1);
        WaitMs(50);

        for(i=0; i<FRAME_BUF_SIZE; i++)
        {
            fb[i]= 0x00;
        }

        lcd_update_rect(rect, fb);
        WaitMs(50);
        break;

    default:
        break;
    }
}

static uint8_t testcase = 0;
void i2c_test(void)
{
    switch(testcase)
    {
    case 0:
        i2c_test_for_ssd1315();
        break;

    default:
        break;
    }
}

void i2c_show_pic(void)
{
    DISP_RECT_FULL(rect);
    lcd_update_rect(rect, PIC1);//show a pic
    WaitMs(50);

    for(int i=0; i<FRAME_BUF_SIZE; i++)
    {
        fb[i]= 0x00;
    }

    lcd_update_rect(rect, fb);//clean oled
    WaitMs(50);
}

